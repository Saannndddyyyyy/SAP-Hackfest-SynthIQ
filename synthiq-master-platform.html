<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SynthIQ ‚Äî Multi-Cluster Intelligence Suite</title>
    <link
        href="https://fonts.googleapis.com/css2?family=DM+Serif+Display:ital@0;1&family=Syne:wght@400;500;600;700;800&family=IBM+Plex+Mono:wght@400;500;600&display=swap"
        rel="stylesheet">
    <style>
        :root {
            --bg: #050508;
            --surface: #0e0e15;
            --surface2: #14141e;
            --border: #242432;
            --accent: #7c6af7;
            --accent-glow: rgba(124, 106, 247, 0.4);
            --accent2: #f97316;
            --accent3: #22d3a5;
            --text: #f1f1f7;
            --muted: #6b6b8b;
            --danger: #f43f5e;
            --gold: #fbbf24;
        }

        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        body {
            background: var(--bg);
            color: var(--text);
            font-family: 'Syne', sans-serif;
            height: 100vh;
            overflow: hidden;
            display: flex;
            flex-direction: column;
        }

        body::before {
            content: '';
            position: fixed;
            inset: 0;
            background-image: url("data:image/svg+xml,%3Csvg viewBox='0 0 256 256' xmlns='http://www.w3.org/2000/svg'%3E%3Cfilter id='noise'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='0.9' numOctaves='4' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='100%25' height='100%25' filter='url(%23noise)' opacity='0.03'/%3E%3C/svg%3E");
            pointer-events: none;
            z-index: 9999;
            opacity: 0.3;
        }

        /* Top Progress Wizard */
        .wizard-header {
            background: var(--surface);
            border-bottom: 1px solid var(--border);
            padding: 20px 60px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .logo h1 {
            font-family: 'DM Serif Display', serif;
            font-size: 24px;
            background: linear-gradient(135deg, var(--accent), var(--accent3));
            -webkit-background-clip: text;
            background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        .step-indicator {
            display: flex;
            gap: 24px;
            position: relative;
        }

        .step {
            display: flex;
            align-items: center;
            gap: 8px;
            color: var(--muted);
            font-size: 11px;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .step.active {
            color: var(--text);
        }

        .step.completed {
            color: var(--accent3);
        }

        .step-num {
            width: 22px;
            height: 22px;
            border-radius: 50%;
            border: 1px solid var(--border);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 9px;
            background: var(--surface2);
        }

        .step.active .step-num {
            border-color: var(--accent);
            color: var(--accent);
            box-shadow: 0 0 8px var(--accent-glow);
        }

        .step.completed .step-num {
            background: var(--accent3);
            border-color: var(--accent3);
            color: var(--bg);
        }

        /* Main Viewport */
        .viewport {
            flex: 1;
            overflow-y: auto;
            padding: 40px 60px;
            max-width: 1200px;
            margin: 0 auto;
            width: 100%;
        }

        .page {
            display: none;
            animation: slideUp 0.6s cubic-bezier(0.16, 1, 0.3, 1);
        }

        .page.active {
            display: block;
        }

        @keyframes slideUp {
            from {
                opacity: 0;
                transform: translateY(30px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .title-block {
            margin-bottom: 40px;
        }

        .title-block h2 {
            font-family: 'DM Serif Display', serif;
            font-size: 40px;
            letter-spacing: -1px;
            margin-bottom: 8px;
        }

        .title-block p {
            color: var(--muted);
            font-size: 16px;
            max-width: 600px;
        }

        /* Component Cards */
        .grid {
            display: grid;
            gap: 20px;
            margin-bottom: 32px;
        }

        .grid-3 {
            grid-template-columns: repeat(3, 1fr);
        }

        .grid-2 {
            grid-template-columns: repeat(2, 1fr);
        }

        .card {
            background: var(--surface);
            border: 1px solid var(--border);
            border-radius: 16px;
            padding: 24px;
            position: relative;
        }

        .card-label {
            font-size: 10px;
            text-transform: uppercase;
            letter-spacing: 2px;
            color: var(--muted);
            margin-bottom: 8px;
            font-weight: 800;
        }

        .card-val {
            font-family: 'DM Serif Display', serif;
            font-size: 28px;
            line-height: 1;
        }

        /* Comparison Badges */
        .badge-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 8px;
            margin-top: 12px;
        }

        .badge {
            padding: 8px;
            border-radius: 6px;
            font-size: 10px;
            font-weight: 800;
            text-align: center;
            border: 1px solid var(--border);
        }

        .badge.pre {
            background: var(--surface2);
            color: var(--accent3);
        }

        .badge.post {
            background: var(--danger);
            color: #fff;
            opacity: 0.8;
        }

        /* Dashboard Chart */
        .dashboard-chart {
            display: flex;
            align-items: flex-end;
            gap: 12px;
            height: 200px;
            padding: 20px;
            background: var(--surface2);
            border-radius: 12px;
            margin-top: 20px;
            border: 1px solid var(--border);
        }

        .chart-bar-wrapper {
            flex: 1;
            display: flex;
            flex-direction: column;
            align-items: center;
            height: 100%;
            justify-content: flex-end;
        }

        .chart-bar {
            width: 100%;
            background: var(--muted);
            border-radius: 4px 4px 0 0;
            transition: all 1s cubic-bezier(0.16, 1, 0.3, 1);
            position: relative;
            cursor: pointer;
        }

        .chart-bar.winner {
            background: var(--accent);
            box-shadow: 0 0 15px var(--accent-glow);
        }

        .chart-bar:hover::after {
            content: attr(data-val) '%';
            position: absolute;
            top: -25px;
            left: 50%;
            transform: translateX(-50%);
            font-size: 10px;
            font-family: 'IBM Plex Mono';
            color: var(--text);
        }

        .chart-label {
            font-size: 7px;
            color: var(--muted);
            text-transform: uppercase;
            margin-top: 8px;
            text-align: center;
            font-weight: 800;
        }

        /* Log Styles */
        .log-container {
            background: #000;
            border: 1px solid var(--border);
            border-radius: 12px;
            height: 200px;
            padding: 12px;
            font-family: 'IBM Plex Mono', monospace;
            font-size: 10px;
            overflow-y: auto;
            color: var(--accent3);
        }

        .log-line {
            margin-bottom: 8px;
            border-left: 3px solid transparent;
            padding-left: 10px;
            line-height: 1.4;
            border-radius: 0 4px 4px 0;
        }

        .log-line.shock {
            background: rgba(244, 63, 94, 0.05);
            color: var(--danger);
            border-color: var(--danger);
        }

        .log-line.personal {
            background: rgba(251, 191, 191, 0.1);
            color: var(--gold);
            border-color: var(--gold);
        }

        .log-line.cultural {
            background: rgba(124, 106, 247, 0.1);
            color: #a78bfa;
            border-color: #7c3aed;
        }

        .log-line small {
            display: block;
            color: rgba(255, 255, 255, 0.4);
            margin-top: 2px;
        }

        /* Final Report Modal */
        #final-report {
            display: none;
            position: fixed;
            inset: 0;
            background: var(--bg);
            z-index: 10001;
            padding: 40px 60px;
            overflow-y: auto;
        }

        /* Leaderboard */
        .leaderboard {
            width: 100%;
            border-collapse: collapse;
            margin-top: 12px;
        }

        .leaderboard th {
            text-align: left;
            font-size: 10px;
            color: var(--muted);
            padding-bottom: 8px;
            border-bottom: 1px solid var(--border);
        }

        .leaderboard td {
            padding: 10px 0;
            font-size: 11px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.05);
        }

        .leaderboard .score {
            font-family: 'IBM Plex Mono';
            font-weight: 800;
        }

        .leaderboard .score.high {
            color: var(--accent3) !important;
        }

        /* Green */
        .leaderboard .score.mid {
            color: var(--gold) !important;
        }

        /* Yellow */
        .leaderboard .score.low {
            color: var(--danger) !important;
        }

        /* Red */

        .leaderboard .rep-tag {
            font-size: 8px;
            background: var(--surface2);
            padding: 2px 6px;
            border-radius: 4px;
            color: var(--muted);
            margin-left: 8px;
        }

        /* Mode Selector */
        .mode-selector {
            display: flex;
            gap: 16px;
            margin-bottom: 32px;
        }

        .mode-btn {
            flex: 1;
            padding: 20px;
            background: var(--surface);
            border: 1px solid var(--border);
            border-radius: 12px;
            cursor: pointer;
            text-align: left;
            transition: all 0.3s;
        }

        .mode-btn.active {
            border-color: var(--accent);
            background: var(--surface2);
            box-shadow: 0 0 20px var(--accent-glow);
        }

        .mode-btn h4 {
            font-family: 'DM Serif Display', serif;
            font-size: 18px;
            margin-bottom: 4px;
        }

        .mode-btn p {
            font-size: 11px;
            color: var(--muted);
        }

        /* Census Hub */
        .census-track {
            height: 32px;
            background: var(--surface2);
            border-radius: 8px;
            display: flex;
            overflow: hidden;
            margin: 16px 0;
            border: 1px solid var(--border);
        }

        .census-seg {
            height: 100%;
            transition: width 1s;
            cursor: pointer;
        }

        .btn {
            padding: 12px 24px;
            border-radius: 10px;
            font-family: 'Syne', sans-serif;
            font-weight: 800;
            font-size: 13px;
            cursor: pointer;
            transition: all 0.2s;
            border: none;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .btn-primary {
            background: var(--accent);
            color: #fff;
        }

        .btn-secondary {
            background: var(--surface2);
            color: var(--text);
            border: 1px solid var(--border);
        }

        .btn:disabled {
            opacity: 0.3;
            cursor: not-allowed;
        }

        .action-footer {
            background: rgba(14, 14, 21, 0.8);
            backdrop-filter: blur(20px);
            border-top: 1px solid var(--border);
            padding: 20px 60px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .overlay {
            position: fixed;
            inset: 0;
            background: rgba(5, 5, 8, 0.95);
            backdrop-filter: blur(20px);
            z-index: 10000;
            display: none;
            align-items: center;
            justify-content: center;
            text-align: center;
        }

        .progress-bar {
            width: 400px;
            height: 4px;
            background: var(--border);
            border-radius: 2px;
            overflow: hidden;
            margin-top: 20px;
        }

        .progress-fill {
            width: 0%;
            height: 100%;
            background: var(--accent);
            transition: width 0.3s;
        }

        textarea {
            background: var(--surface2);
            border: 1px solid var(--border);
            color: var(--text);
            padding: 12px;
            border-radius: 8px;
            outline: none;
            font-family: 'Syne';
            font-size: 12px;
            resize: none;
            width: 100%;
        }

        /* Opportunity Card */
        .opp-card {
            background: linear-gradient(135deg, #14141e, #0e0e15);
            border: 1px solid var(--gold);
            border-radius: 16px;
            padding: 24px;
            position: relative;
            overflow: hidden;
        }

        .opp-card::after {
            content: 'CONVERSION TARGET';
            position: absolute;
            top: 12px;
            right: -30px;
            background: var(--gold);
            color: #000;
            font-size: 8px;
            font-weight: 900;
            padding: 4px 40px;
            transform: rotate(45deg);
        }

        .verbatim-text {
            font-family: 'Syne';
            font-size: 13px;
            line-height: 1.6;
            font-style: italic;
            color: var(--text);
        }

        .verbatim-author {
            margin-top: 12px;
            font-size: 9px;
            font-weight: 700;
            color: var(--accent3);
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        /* Pulse Dashboard Layout */
        .pulse-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            grid-template-rows: auto auto;
            gap: 20px;
            margin-top: 24px;
        }

        .pulse-quad {
            background: var(--surface);
            border: 1px solid var(--border);
            border-radius: 20px;
            padding: 24px;
            position: relative;
            min-height: 280px;
            display: flex;
            flex-direction: column;
        }

        .pulse-quad.central-map {
            grid-row: span 2;
            min-height: 580px;
        }

        .pulse-kpi-row {
            display: flex;
            gap: 24px;
            margin-bottom: 20px;
        }

        .pulse-kpi {
            flex: 1;
        }

        .pulse-kpi label {
            display: block;
            font-size: 10px;
            text-transform: uppercase;
            letter-spacing: 1.5px;
            color: var(--muted);
            margin-bottom: 6px;
            font-weight: 800;
        }

        .pulse-kpi span {
            font-family: 'DM Serif Display';
            font-size: 32px;
            color: var(--text);
        }

        .pulse-chart-container {
            flex: 1;
            min-height: 150px;
            position: relative;
        }

        /* SVG Heatmap Styles */
        .state-path {
            transition: fill 0.4s cubic-bezier(0.4, 0, 0.2, 1);
            cursor: pointer;
        }

        .state-path:hover {
            filter: brightness(1.3);
            stroke: #fff;
            stroke-width: 1.5;
        }

        /* Radar Chart Markers */
        .radar-label {
            font-family: 'IBM Plex Mono';
            font-size: 8px;
            font-weight: 700;
            fill: var(--muted);
            text-transform: uppercase;
        }

        /* === DriftLab v2 Upgrade Styles === */
        .driftlab-container {
            display: grid;
            grid-template-columns: 320px 1fr;
            gap: 24px;
            margin-top: 20px;
            font-family: 'Syne', sans-serif;
        }

        .drift-controls {
            background: var(--surface);
            border: 1px solid var(--border);
            border-radius: 20px;
            padding: 24px;
            display: flex;
            flex-direction: column;
            gap: 24px;
            height: fit-content;
            position: sticky;
            top: 20px;
        }

        .drift-section-label {
            font-size: 11px;
            text-transform: uppercase;
            letter-spacing: 2px;
            color: var(--muted);
            margin-bottom: 16px;
            font-weight: 700;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .drift-section-label::after {
            content: '';
            flex: 1;
            height: 1px;
            background: var(--border);
        }

        .drift-control-group {
            margin-bottom: 20px;
        }

        .drift-control-header {
            display: flex;
            justify-content: space-between;
            font-size: 13px;
            font-weight: 700;
            margin-bottom: 12px;
            color: var(--text);
        }

        .drift-val {
            color: var(--accent);
            font-family: 'IBM Plex Mono';
        }

        .drift-slider {
            width: 100%;
            -webkit-appearance: none;
            height: 4px;
            background: var(--border);
            border-radius: 2px;
            outline: none;
        }

        .drift-slider::-webkit-slider-thumb {
            -webkit-appearance: none;
            width: 16px;
            height: 16px;
            border-radius: 50%;
            background: var(--accent);
            cursor: pointer;
            box-shadow: 0 0 10px var(--accent-glow);
        }

        .persona-drift-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
            gap: 16px;
        }

        .drift-card {
            background: var(--surface);
            border: 1px solid var(--border);
            border-radius: 16px;
            padding: 24px;
            position: relative;
            overflow: hidden;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            animation: slideIn 0.5s ease backwards;
        }

        .drift-card.active-shock {
            border-color: var(--accent2);
            box-shadow: 0 0 20px rgba(249, 115, 22, 0.15);
        }

        .drift-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            bottom: 0;
            width: 4px;
            background: var(--accent);
        }

        .drift-card-name {
            font-weight: 800;
            font-size: 20px;
            color: var(--text);
        }

        .drift-card-label {
            font-size: 11px;
            color: var(--muted);
            text-transform: uppercase;
            letter-spacing: 1px;
            margin-bottom: 20px;
        }

        .drift-stat {
            display: flex;
            justify-content: space-between;
            font-size: 13px;
            margin-bottom: 10px;
        }

        .drift-stat label {
            color: var(--muted);
        }

        .drift-stat span {
            font-family: 'IBM Plex Mono';
            font-weight: 600;
        }

        .drift-prob-container {
            margin-top: 20px;
            padding-top: 20px;
            border-top: 1px solid var(--border);
        }

        .drift-prob-header {
            display: flex;
            justify-content: space-between;
            font-size: 14px;
            font-weight: 600;
            margin-bottom: 8px;
        }

        .drift-prob-bar {
            height: 10px;
            background: var(--surface2);
            border-radius: 5px;
            overflow: hidden;
        }

        .drift-prob-fill {
            height: 100%;
            background: linear-gradient(90deg, var(--accent), #d8b4fe);
            width: 0%;
            transition: width 1s cubic-bezier(0.34, 1.56, 0.64, 1);
        }

        .drift-pill {
            display: inline-block;
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 11px;
            font-weight: 700;
            margin-top: 12px;
        }

        .drift-pill.down {
            background: rgba(239, 68, 68, 0.2);
            color: #fca5a5;
        }

        .drift-pill.up {
            background: rgba(16, 185, 129, 0.2);
            color: #6ee7b7;
        }

        .drift-shock-pill {
            background: rgba(249, 115, 22, 0.2);
            color: #fdba74;
            display: block;
            border: 1px solid rgba(249, 115, 22, 0.3);
            margin-top: 10px;
            padding: 6px 12px;
            font-size: 11px;
            font-weight: 700;
            border-radius: 20px;
            text-align: center;
        }

        .drift-log-panel {
            background: var(--surface);
            border: 1px solid var(--border);
            border-radius: 16px;
            padding: 24px;
            height: 250px;
            overflow-y: auto;
            font-family: 'IBM Plex Mono', monospace;
            font-size: 12px;
            margin-top: 24px;
        }

        .drift-log-entry.macro {
            border-left-color: var(--accent);
        }

        .drift-log-entry.personal {
            border-left-color: var(--accent2);
            background: rgba(249, 115, 22, 0.05);
        }

        .drift-log-entry.cultural {
            border-left-color: var(--accent3);
            background: rgba(34, 211, 165, 0.05);
        }

        .drift-log-time {
            color: var(--muted);
            margin-right: 12px;
        }

        .drift-log-shock {
            color: var(--accent2);
            font-weight: 700;
        }

        .state-options {
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            background: var(--surface2);
            border: 1px solid var(--border);
            border-top: none;
            border-radius: 0 0 8px 8px;
            display: none;
            z-index: 100;
            max-height: 200px;
            overflow-y: auto;
            padding: 8px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.5);
        }

        .state-options.open {
            display: block;
        }

        .state-option {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 8px;
            cursor: pointer;
            border-radius: 4px;
            font-size: 12px;
            transition: background 0.2s;
        }

        .state-option:hover {
            background: var(--surface);
        }

        /* === Step 5: AI Market Intelligence Dashboard === */
        .pulse-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            grid-template-rows: auto auto;
            gap: 20px;
            margin-top: 24px;
        }

        /* Adaptive Layout for Product Acceptance Mode */
        .pulse-grid.acceptance-mode {
            grid-template-columns: 350px 1fr;
            grid-template-rows: auto auto;
        }

        .pulse-grid.acceptance-mode .pulse-quad:first-child {
            display: none;
            /* Hide A/B Results */
        }

        .pulse-grid.acceptance-mode .pulse-quad:nth-child(2) {
            grid-column: 1;
            grid-row: 1;
        }

        .pulse-grid.acceptance-mode .pulse-quad:nth-child(4) {
            grid-column: 1;
            grid-row: 2;
        }

        .pulse-grid.acceptance-mode .pulse-quad:nth-child(3) {
            grid-column: 2;
            grid-row: 1 / span 2;
            /* Audience Insights expands */
            justify-content: center;
        }

        .pulse-quad {
            background: rgba(26, 31, 46, 0.6);
            backdrop-filter: blur(12px);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 16px;
            padding: 20px;
            position: relative;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.3);
            display: flex;
            flex-direction: column;
            transition: all 0.4s cubic-bezier(0.165, 0.84, 0.44, 1);
        }

        .pulse-quad:hover {
            border-color: rgba(255, 255, 255, 0.2);
        }

        /* Scaling for Enlarged Insights */
        .acceptance-mode #age-donut,
        .acceptance-mode #income-donut {
            height: 180px !important;
            width: 180px !important;
        }

        .acceptance-mode #personality-radar {
            height: 320px !important;
            margin-top: 20px;
        }

        .acceptance-mode .insight-grid {
            gap: 40px;
            justify-content: center;
        }

        .pulse-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.05);
            padding-bottom: 12px;
        }

        .pulse-title {
            font-size: 13px;
            font-weight: 700;
            color: var(--text);
            text-transform: uppercase;
            letter-spacing: 1.5px;
        }

        /* A/B Test Results */
        .ab-pair {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 16px;
            flex: 1;
        }

        .ab-option {
            background: rgba(255, 255, 255, 0.02);
            border-radius: 12px;
            padding: 16px;
            text-align: center;
            border: 1px solid rgba(255, 255, 255, 0.05);
        }

        .ab-label {
            font-size: 11px;
            color: var(--muted);
            margin-bottom: 8px;
        }

        .ab-concept {
            font-size: 14px;
            font-weight: 800;
            color: var(--text);
            margin-bottom: 12px;
        }

        .ab-metric {
            font-size: 10px;
            color: var(--muted);
            margin-top: 4px;
        }

        .ab-val {
            font-family: 'IBM Plex Mono';
            font-size: 18px;
            font-weight: 800;
            color: var(--accent);
        }

        /* Product Brief Testing */
        .pbrief-content {
            display: grid;
            grid-template-columns: 140px 1fr;
            gap: 20px;
            align-items: center;
        }

        .pbrief-img {
            height: 120px;
            background: linear-gradient(135deg, rgba(255, 255, 255, 0.05), rgba(255, 255, 255, 0.01));
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            border: 1px solid rgba(255, 255, 255, 0.05);
        }

        .pbrief-stats {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .pbrief-stat-row {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 12px;
            color: var(--text);
        }

        .dot {
            height: 8px;
            width: 8px;
            border-radius: 50%;
            display: inline-block;
        }

        .dot.positive {
            background: #10b981;
            box-shadow: 0 0 10px #10b981;
        }

        .dot.negative {
            background: #ef4444;
            box-shadow: 0 0 10px #ef4444;
        }

        /* Audience Insights / Feedback */
        .insight-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 16px;
            flex: 1;
        }

        .donut-container {
            flex: 1;
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        .feedback-sect {
            margin-bottom: 16px;
        }

        .feedback-label {
            font-size: 11px;
            font-weight: 800;
            padding: 4px 12px;
            border-radius: 4px;
            display: inline-block;
            margin-bottom: 8px;
            text-transform: uppercase;
        }

        .label-likes {
            background: rgba(16, 185, 129, 0.2);
            color: #10b981;
            border: 1px solid rgba(16, 185, 129, 0.3);
        }

        .label-concerns {
            background: rgba(239, 68, 68, 0.2);
            color: #ef4444;
            border: 1px solid rgba(239, 68, 68, 0.3);
        }

        .label-quotes {
            background: rgba(168, 85, 247, 0.2);
            color: #a855f7;
            border: 1px solid rgba(168, 85, 247, 0.3);
        }

        .feedback-list {
            list-style: none;
            padding: 0;
            margin: 0;
            display: flex;
            flex-direction: column;
            gap: 6px;
        }

        .feedback-item {
            font-size: 11px;
            color: var(--text);
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .quote-bubble {
            background: rgba(255, 255, 255, 0.05);
            padding: 10px;
            border-radius: 8px;
            font-style: italic;
            font-size: 11px;
            line-height: 1.4;
            border-left: 2px solid var(--accent3);
            margin-bottom: 8px;
        }

        .dashboard-header-pulse {
            display: flex;
            justify-content: space-between;
            align-items: flex-end;
            margin-bottom: 24px;
            padding-bottom: 16px;
            border-bottom: 1px solid var(--border);
        }

        .badge-mini {
            font-size: 9px;
            font-weight: 700;
            padding: 4px 8px;
            background: var(--surface2);
            border: 1px solid var(--border);
            border-radius: 4px;
            color: var(--muted);
            margin-left: 8px;
        }
    </style>
</head>

<body>
    <div class="overlay" id="sim-overlay">
        <div style="width:450px">
            <h3 id="sim-title" style="font-family:'DM Serif Display'; font-size:28px;"></h3>
            <div class="progress-bar" style="margin: 24px auto;">
                <div class="progress-fill" id="sim-progress"></div>
            </div>
            <p id="sim-status" style="color:var(--muted); font-size:13px; font-family:'IBM Plex Mono';"></p>
        </div>
    </div>

    <!-- MASTER BRIEFING DASHBOARD -->
    <div id="final-report">
        <div style="max-width: 1200px; margin: 0 auto;">
            <div
                style="border-bottom: 1px solid var(--border); padding-bottom: 32px; margin-bottom: 32px; display: flex; justify-content: space-between; align-items: flex-end;">
                <div>
                    <h1 style="font-family:'DM Serif Display'; font-size:48px;">Phase 4: Resilience Audit Report</h1>
                    <p style="color:var(--muted); font-weight:700; letter-spacing:2px; text-transform:uppercase;"
                        id="rep-mode-title">Resilience Analysis ‚Äî 50,000 Agents Audit</p>
                </div>
                <button class="btn btn-secondary"
                    onclick="document.getElementById('final-report').style.display='none'">Confirm Audit & Continue to
                    Step 5</button>
            </div>

            <div class="grid grid-3">
                <div class="card">
                    <div class="card-label">Market Adoption index</div>
                    <div class="card-val" id="rep-pre">--</div>
                </div>
                <div class="card">
                    <div class="card-label">Resilience to Drift</div>
                    <div class="card-val" id="rep-post">--</div>
                </div>
                <div class="card">
                    <div class="card-label" style="color:var(--gold)">Target Opportunity cluster</div>
                    <div class="card-val" id="rep-winner" style="font-size:18px; color:var(--accent3)">--</div>
                </div>
            </div>

            <!-- Dashboard Charts Section -->
            <div style="display:grid; grid-template-columns: 1.5fr 1fr; gap:32px; margin-top:24px;">
                <div class="card">
                    <div class="card-label">Cluster Sentiment Analysis (Post-Drift)</div>
                    <div class="dashboard-chart" id="dashboard-chart"></div>
                    <p style="margin-top:16px; font-size:11px; color:var(--muted);">The blue bar highlights your
                        <b>Target
                            Acquisition Segment</b> (highest post-drift affinity).
                    </p>
                </div>
                <div class="card">
                    <div class="card-label" id="sample-label">Representative Audience Sample (Cultural Stratification)
                    </div>
                    <table class="leaderboard">
                        <thead>
                            <tr>
                                <th>Name</th>
                                <th>Demographics (Age/Gen/State)</th>
                                <th>Archetype</th>
                                <th>Brief</th>
                                <th>Intent</th>
                            </tr>
                        </thead>
                        <tbody id="rep-sample-body"></tbody>
                    </table>
                </div>
            </div>

            <div style="display:grid; grid-template-columns: 1fr 1fr; gap:32px; margin-top:32px;">
                <div class="opp-card">
                    <div class="card-label" style="color:var(--gold)">Improvement Roadmap ‚Äî Voice of the Customer</div>
                    <h4 style="font-family:'DM Serif Display'; font-size:20px; margin: 8px 0;" id="rep-opp-title">
                        High-Friction enthusiast</h4>
                    <p id="rep-opp-verbatim" class="verbatim-text"></p>
                </div>
                <div class="card">
                    <div class="card-label">Market Fit Drivers</div>
                    <div class="drivers-grid" id="market-drivers">
                        <!-- Populated by JS -->
                    </div>
                </div>
                <div class="card" style="grid-column: span 2;">
                    <div class="card-label">Consumer Sentiment Logic</div>
                    <div class="insight-box" id="sentiment-insight">
                        <b>Crowd Synchronization</b>
                        The strategy strongly connects with the broader market because it aligns with financial reality
                        and emotional comfort.
                    </div>
                </div>
                <div class="card" style="grid-column: span 2;">
                    <div class="card-label">Macro-Resilience Summary</div>
                    <p style="color:var(--muted); margin-top:12px; line-height:1.6; font-size:14px;" id="rep-rationale">
                    </p>
                </div>
            </div>
        </div>
    </div>
    <header class="wizard-header">
        <div class="logo">
            <h1>SynthIQ</h1>
        </div>
        <div class="step-indicator">
            <div class="step active" id="st-1">
                <div class="step-num">1</div>Foundation
            </div>
            <div class="step" id="st-2">
                <div class="step-num">2</div>Simulation
            </div>
            <div class="step" id="st-3">
                <div class="step-num">3</div>Drift
            </div>
            <div class="step" id="st-4">
                <div class="step-num">4</div>Audit
            </div>
            <div class="step" id="st-5">
                <div class="step-num">5</div>Pulse
            </div>
        </div>
        <div style="font-size:10px; color:var(--muted); font-family:'IBM Plex Mono'">SYNTHIQ_HACK_V12</div>
    </header>
    <main class="viewport">
        <!-- STEP 1: INITIALIZATION -->
        <div id="page-1" class="page active">
            <div class="title-block">
                <h2>Synthetic Methodology</h2>
                <p>Synthesize a high-resolution market grid of 50,000 agents with individual life-markers (Age, Income,
                    Big Five).</p>
            </div>
            <div class="card-label">Simulation Mode</div>
            <div class="mode-selector">
                <div class="mode-btn active" onclick="setMode('acceptance')" id="mode-acceptance">
                    <h4>Product Acceptance</h4>
                    <p>Testing specific product resonance and friction barriers.</p>
                </div>
                <div class="mode-btn" onclick="setMode('ab')" id="mode-ab">
                    <h4>A/B Strategy Testing</h4>
                    <p>Comparing resonance between two strategic marketing vectors.</p>
                </div>
            </div>
            <div class="card" style="margin-bottom:24px;">
                <div class="card-label">Target Geography (India)</div>
                <div class="state-selector-container">
                    <div class="state-dropdown-trigger" id="state-trigger" onclick="toggleStateDropdown()">Select
                        Target States (All by default)</div>
                    <div class="state-options" id="state-options">
                        <!-- Populated by JS -->
                    </div>
                </div>
            </div>
            <div class="card" style="margin-bottom:24px;">
                <div class="card-label">Audience Scale</div>
                <div style="display:flex; align-items:center; gap:24px; margin-top:12px;"><input type="range" min="1000"
                        max="50000" step="1000" value="50000" id="pop-slider" oninput="updatePopLabel()"
                        style="flex:1;">
                    <div id="pop-label"
                        style="font-family:'IBM Plex Mono'; font-size:28px; font-weight:800; color:var(--accent); width:150px;">
                        50,000</div>
                </div>
            </div><button class="btn btn-primary" onclick="initAgents()">‚óà CONSTRUCT MARKET DNA</button>
            <div id="res-1" style="display:none; margin-top:24px;">
                <div class="card-label">Audience Grid Census</div>
                <div class="census-track" id="census-track"></div>
                <div id="census-legend"
                    style="display:grid; grid-template-columns:repeat(5, 1fr); gap:12px; font-size:9px; color:var(--muted); margin-top:12px;">
                </div>
            </div>
        </div>
        <!-- STEP 2: RESONANCE -->
        <div id="page-2" class="page">
            <div id="view-acceptance" style="display:none;">
                <div class="title-block">
                    <h2>Product Proposition</h2>
                    <p>Define your product to trigger the semantic resonance engine.</p>
                </div>
                <div class="card">
                    <div class="card-label">Product Context</div><textarea id="product-desc" style="height:120px;">Eco-Tech Student Laptop: ‚Çπ32,
        999. Recycled aluminum,
        18-hr battery,
        integrated solar charging on lid. Perfect for budget-conscious creators.</textarea>
                </div>
            </div>
            <div id="view-ab" style="display:none;">
                <div class="title-block">
                    <h2>A/B Comparative Simulator</h2>
                    <p>Calculate resonance for two distinct strategic paths.</p>
                </div>
                <div class="grid grid-2">
                    <div class="card">
                        <div class="card-label">Variation A</div><textarea id="desc-a">Status & Luxury: ‚Çπ1,
        500/mo access fee. VIP event invites and priority concierge service.</textarea>
                    </div>
                    <div class="card">
                        <div class="card-label">Variation B</div><textarea id="desc-b">Utility & Value: ‚Çπ29/day pay-as-you-go. Cancel anytime,
        focused on student essentials.</textarea>
                    </div>
                </div>
            </div>
            <button class="btn btn-primary" onclick="runSimulation()" style="margin-top:20px;">‚ñ∂ RUN
                NEURAL PROPAGATION</button>
            <div id="res-2" style="display:none; margin-top:24px;">
                <div class="grid grid-2">
                    <div class="card">
                        <div class="card-label" id="res2-label1">Winning Strategy</div>
                        <div class="card-val" id="res2-val1">--</div>
                    </div>
                    <div class="card">
                        <div class="card-label">Market Fit confidence</div>
                        <div class="card-val" id="res2-val2">--</div>
                    </div>
                </div>
                <div class="verbatim-card">
                    <div class="card-label" style="color:var(--accent3)">Hero Persona Verification</div>
                    <p id="hero-verbatim" class="verbatim-text"></p>
                    <div
                        style="display:flex; justify-content:space-between; align-items:flex-end; margin-bottom: 12px;">
                        <div id="hero-name" class="verbatim-author"></div>
                        <div id="hero-demographics" style="font-size:9px; color:var(--muted); font-weight:700;">
                        </div>
                    </div>
                    <div id="hero-insight" class="insight-box" style="display:none;"></div>
                </div>
            </div>
        </div>
        <!-- STEP 3: DRIFT -->
        <div id="page-3" class="page">
            <div class="title-block">
                <h2>Market Drift Simulation</h2>
                <p>Observe real-time sentiment erosion by injecting macro-economic stressors and random personal shocks.
                </p>
            </div>

            <div class="driftlab-container">
                <!-- Left: Controls -->
                <div class="drift-controls">
                    <section>
                        <div class="drift-section-label">Macro Stressors</div>
                        <div class="drift-control-group">
                            <div class="drift-control-header"><span>Inflation</span><span class="drift-val"
                                    id="val-inflation">3.0%</span></div>
                            <input type="range" id="input-inflation" class="drift-slider" min="0" max="10" step="0.1"
                                value="3.0">
                        </div>
                        <div class="drift-control-group">
                            <div class="drift-control-header"><span>Interest Rate</span><span class="drift-val"
                                    id="val-rates">5.0%</span></div>
                            <input type="range" id="input-rates" class="drift-slider" min="0" max="15" step="0.1"
                                value="5.0">
                        </div>
                        <div class="drift-control-group">
                            <div class="drift-control-header"><span>Unemployment</span><span class="drift-val"
                                    id="val-unemployment">4.0%</span></div>
                            <input type="range" id="input-unemployment" class="drift-slider" min="0" max="20" step="0.1"
                                value="4.0">
                        </div>
                        <div class="drift-control-group">
                            <div class="drift-control-header"><span>GDP Growth</span><span class="drift-val"
                                    id="val-gdp">6.5%</span></div>
                            <input type="range" id="input-gdp" class="drift-slider" min="0" max="12" step="0.1"
                                value="6.5">
                        </div>
                    </section>

                    <section>
                        <div class="drift-section-label">Manual Product Faults</div>
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 8px;">
                            <button class="trigger-btn setback-btn" data-setback="Price Hike"><span>üè∑Ô∏è</span> Price
                                Hike</button>
                            <button class="trigger-btn setback-btn" data-setback="Feature Del"><span>üö´</span> Feature
                                Del</button>
                            <button class="trigger-btn setback-btn" data-setback="Outage"><span>üìâ</span>
                                Outage</button>
                            <button class="trigger-btn setback-btn" data-setback="Support Lag"><span>‚òéÔ∏è</span> Support
                                Lag</button>
                        </div>
                    </section>

                    <button class="btn btn-primary" onclick="propagateDrift()" style="width: 100%; margin-top: 24px;">‚óà
                        FINALIZE DRIFT TRIGGERS</button>

                    <button id="reset-drift-btn" class="btn btn-secondary"
                        style="width: 100%; border-color: var(--danger); color: var(--danger); justify-content: center; margin-top: 12px;">
                        REVERT TO BASELINE
                    </button>
                </div>

                <!-- Right: Display -->
                <div style="display: flex; flex-direction: column; gap: 24px;">
                    <div class="persona-drift-grid" id="drift-cards-container">
                        <!-- 10 Archetype Sentiment Cards populated by JS -->
                    </div>

                    <section>
                        <div class="drift-section-label">Real-Time Behavioral Drift Log</div>
                        <div class="drift-log-panel" id="drift-logs">
                            <!-- Live Event Stream -->
                        </div>
                    </section>
                </div>
            </div>
        </div>
        <!-- STEP 4: AUDIT -->
        <div id="page-4" class="page">
            <div class="title-block">
                <h2>Resilience Impact Audit</h2>
                <p>Identifying the most loyal target cluster by auditing 50,000 unique intent trajectories.</p>
            </div>
            <div class="grid grid-2">
                <div class="card">
                    <div class="card-label">Individual Intent Fracture (Pre vs Post Drift)</div>
                    <div class="badge-grid">
                        <div class="badge pre">BASE: <span id="hero-pre-val">--</span></div>
                        <div class="badge post">POST: <span id="hero-post-val">--</span></div>
                    </div>
                    <div class="verbatim-card" style="margin-top:16px;">
                        <p id="hero-drift-verbatim" class="verbatim-text"></p>
                        <div style="display:flex; justify-content:space-between; align-items:flex-end;">
                            <div id="hero-drift-name" class="verbatim-author"></div>
                            <div id="hero-drift-demographics"
                                style="font-size:9px; color:var(--muted); font-weight:700;"></div>
                        </div>
                    </div>
                </div>
                <div id="hero-drift-insight" class="insight-box" style="display:none;"></div>
            </div>
            <div class="card">
                <div class="card-label" id="buyer-sample-title">Representative Sample (Cultural Mix)
                </div>
                <table class="leaderboard">
                    <thead>
                        <tr>
                            <th>Name</th>
                            <th>Age</th>
                            <th>Gen</th>
                            <th>State</th>
                            <th>Archetype</th>
                            <th>Brief</th>
                            <th>Final Intent</th>
                        </tr>
                    </thead>
                    <tbody id="audit-sample-body"></tbody>
                </table>
            </div>
            <button class="btn btn-primary" onclick="runResilience()" style="margin-top:20px;">‚óà EXECUTE RESILIENCE
                AUDIT</button>
        </div>

        <!-- STEP 5: AI MARKET INTELLIGENCE DASHBOARD -->
        <div id="page-5" class="page">
            <div class="dashboard-header-pulse">
                <div>
                    <h2
                        style="font-family:'DM Serif Display'; font-size:32px; color:var(--text); letter-spacing: -0.5px;">
                        AI Market Intelligence Dashboard</h2>
                    <div
                        style="font-size:12px; color:var(--muted); font-family:'IBM Plex Mono'; margin-top:4px; display: flex; align-items: center; gap: 16px;">
                        <span>POPULATION: 50,000 HOUSEHOLDS</span>
                        <span style="color:var(--border)">|</span>
                        <span>CONFIDENCE: <span id="pulse-conf" style="color:var(--accent3)">94.2%</span></span>
                        <span style="color:var(--border)">|</span>
                        <span>ENV: <span id="pulse-env" style="color:var(--accent2)">ADAPTIVE</span></span>
                    </div>
                </div>
                <div class="shock-badges-pulse" id="pulse-shocks">
                    <!-- Badges injected by updateSimulation -->
                </div>
            </div>

            <div class="pulse-grid">
                <!-- Top Left: A/B Test Results -->
                <div class="pulse-quad">
                    <div class="pulse-header"><span class="pulse-title">A/B Test Results</span></div>
                    <div class="ab-pair">
                        <div class="ab-option">
                            <div class="ab-label">Option A</div>
                            <div id="ab-icon-a" style="font-size:40px; margin-bottom:12px;">üì±</div>
                            <div class="ab-concept" id="ab-name-a">Concept A</div>
                            <div class="ab-metric">Conversion Rate: <span class="ab-val" id="ab-conv-a">--%</span></div>
                            <div class="ab-metric">User Preference: <span class="ab-val" id="ab-pref-a">--%</span></div>
                        </div>
                        <div class="ab-option">
                            <div class="ab-label">Option B</div>
                            <div id="ab-icon-b" style="font-size:40px; margin-bottom:12px;">‚åö</div>
                            <div class="ab-concept" id="ab-name-b">Concept B</div>
                            <div class="ab-metric">Conversion Rate: <span class="ab-val" id="ab-conv-b">--%</span></div>
                            <div class="ab-metric">User Preference: <span class="ab-val" id="ab-pref-b">--%</span></div>
                        </div>
                    </div>
                </div>

                <!-- Top Right: Product Brief Testing -->
                <div class="pulse-quad">
                    <div class="pulse-header"><span class="pulse-title">Product Brief Testing</span></div>
                    <div class="pbrief-content">
                        <div class="pbrief-img" id="pbrief-visual">
                            <!-- SVG/CSS Product Representation -->
                            <div style="font-size:60px;">üéß</div>
                        </div>
                        <div class="pbrief-stats">
                            <div style="font-weight:700; font-size:15px; margin-bottom:15px;" id="pbrief-name">Product
                                Concept</div>
                            <div class="pbrief-stat-row">
                                <span class="dot positive"></span> Avg Purchase Likelihood: <b
                                    style="color:var(--accent); font-size:16px;" id="pbrief-likelihood">--%</b>
                            </div>
                            <div class="pbrief-stat-row">
                                <span class="dot positive"></span> Positive Sentiment: <b
                                    style="color:var(--accent3); font-size:16px;" id="pbrief-sentiment">--%</b>
                            </div>
                            <div
                                style="margin-top:15px; font-size:10px; color:var(--muted); text-transform:uppercase; letter-spacing:1px;">
                                Key Concerns:</div>
                            <div id="pbrief-concerns" style="display:flex; gap:8px; flex-wrap:wrap; margin-top:5px;">
                                <!-- Tags injected -->
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Bottom Left: Audience Insights -->
                <div class="pulse-quad">
                    <div class="pulse-header"><span class="pulse-title">Audience Insights</span></div>
                    <div class="insight-grid" style="align-items: center;">
                        <div class="donut-container">
                            <div
                                style="font-size:9px; color:var(--muted); margin-bottom:10px; text-transform:uppercase;">
                                Age Distribution</div>
                            <div id="age-donut" style="height:110px; width:110px;">
                                <!-- SVG Donut -->
                            </div>
                        </div>
                        <div class="donut-container">
                            <div
                                style="font-size:9px; color:var(--muted); margin-bottom:10px; text-transform:uppercase;">
                                Income Levels</div>
                            <div id="income-donut" style="height:110px; width:110px;">
                                <!-- SVG Donut -->
                            </div>
                        </div>
                    </div>
                    <div style="margin-top:10px; text-align:center; flex:1;">
                        <div style="font-size:9px; color:var(--muted); margin-bottom:5px; text-transform:uppercase;">
                            Personality Traits</div>
                        <div id="personality-radar"
                            style="height:130px; display: flex; justify-items: center; align-items: center; justify-content: center;">
                            <!-- SVG Radar -->
                        </div>
                    </div>
                </div>

                <!-- Bottom Right: Feedback Themes -->
                <div class="pulse-quad">
                    <div class="pulse-header"><span class="pulse-title">Feedback Themes</span></div>
                    <div class="grid grid-2" style="gap:20px;">
                        <div class="feedback-sect">
                            <div class="feedback-label label-likes">Likes</div>
                            <ul class="feedback-list" id="feedback-likes">
                                <!-- List injected -->
                            </ul>
                        </div>
                        <div class="feedback-sect">
                            <div class="feedback-label label-concerns">Concerns</div>
                            <ul class="feedback-list" id="feedback-concerns">
                                <!-- List injected -->
                            </ul>
                        </div>
                    </div>
                    <div style="margin-top:10px;">
                        <div class="feedback-label label-quotes">Quotes</div>
                        <div id="feedback-quotes">
                            <!-- Quotes injected -->
                        </div>
                    </div>
                </div>
            </div>
        </div>
        </div>
    </main>
    <footer class="action-footer"><button class="btn btn-secondary" onclick="prevStep()" id="btn-back">‚Üê Back</button>
        <div id="status-hint" style="color:var(--muted); font-size:12px;">Phase 1: methodology Construction.</div>
        <button class="btn btn-primary" onclick="nextStep()" id="btn-next">Next Step ‚Üí</button>
    </footer>
    <script>const FIRST_NAMES = ["Rajesh",
            "Sameet",
            "Aditi",
            "Vikram",
            "Tanya",
            "Pramod",
            "Neha",
            "Keshav",
            "Sanya",
            "Arjun",
            "Tushar",
            "Priya",
            "Meera",
            "Anil",
            "Deepak",
            "Riya",
            "Kavya",
            "Siddharth",
            "Ishaan",
            "Zoya"];
        const LAST_NAMES = ["Sharma",
            "Singh",
            "Gupta",
            "Kapoor",
            "Reddy",
            "Patel",
            "Mehra",
            "Verma",
            "Iyer",
            "Nair"];

        const ARCHETYPES = [{
            name: "The Value Dailyists", weight: 0.12, color: '#7c6af7', sensitivity: 1.5, age: 28, income: 45000, phrases: ["Budget-first daily commuter", "Utility-focused student", "Eco-conscious value hunter"]
        }

            ,
        {
            name: "The Stressed Savers", weight: 0.15, color: '#4f46e5', sensitivity: 1.8, age: 42, income: 35000, phrases: ["Conservative family manager", "Inflation-sensitive saver", "Risk-averse budget balancing"]
        }

            ,
        {
            name: "The Aspiring Climbers", weight: 0.18, color: '#22d3a5', sensitivity: 1.1, age: 24, income: 60000, phrases: ["Early-career tech enthusiast", "Brand-aware city dweller", "Upwardly mobile professional"]
        }

            ,
        {
            name: "The Career Minimalists", weight: 0.10, color: '#10b981', sensitivity: 0.9, age: 35, income: 80000, phrases: ["Efficiency-driven worker", "Pragmatic tech adopter", "Low-friction lifestyle seeker"]
        }

            ,
        {
            name: "The Premium Loyalists", weight: 0.08, color: '#f97316', sensitivity: 0.4, age: 38, income: 150000, phrases: ["Quality-first brand loyalist", "Status-aware tech investor", "Premium experience seeker"]
        }

            ,
        {
            name: "The Heritage Elite", weight: 0.05, color: '#ea580c', sensitivity: 0.2, age: 55, income: 300000, phrases: ["Legacy asset protector", "Conservative luxury buyer", "Stability-focused decision maker"]
        }

            ,
        {
            name: "The Budget Cautious", weight: 0.14, color: '#f43f5e', sensitivity: 1.3, age: 31, income: 28000, phrases: ["Cost-sensitive survivor", "Bargain-driven consumer", "Liquidity-focused spender"]
        }

            ,
        {
            name: "The Risk Averse", weight: 0.10, color: '#e11d48', sensitivity: 1.4, age: 48, income: 55000, phrases: ["Stability-seeking planner", "Known-brand only adopter", "Change-resistant consumer"]
        }

            ,
        {
            name: "The Power Professionals", weight: 0.05, color: '#ec4899', sensitivity: 0.5, age: 29, income: 180000, phrases: ["High-output city executive", "Cutting-edge tech adopter", "Value-per-hour optimizer"]
        }

            ,
        {
            name: "The Asset Secure", weight: 0.03, color: '#db2777', sensitivity: 0.3, age: 50, income: 250000, phrases: ["Asset-backed luxury buyer", "Resilient high-net-worth", "Philanthropic trend-setter"]
        }

        ];

        let agents = [];
        let currentStep = 1;
        let simMode = 'acceptance';
        let stepCompleted = [false,
            false,
            false,
            false,
            false,
            false];
        let popSize = 50000;
        let heroAgent = null;
        let targetCluster = "";

        const SHOCK_LIBRARY = [{
            type: "HEALTH EMERGENCY", text: "Sudden medical hospitalization in family. Emergency savings diverted.", drop: 25
        }

            ,
        {
            type: "RENTAL SPIKE", text: "Property owner increased rent by 20% overnight. Disposable income crashed.", drop: 15
        }

            ,
        {
            type: "JOB RESTRUCTURING", text: "Corporate downsizing announced. Transitioning to survival mode.", drop: 30
        }

            ,
        {
            type: "VEHICLE REPAIR", text: "Major mechanical failure in primary transport. High upfront cost.", drop: 12
        }

            ,
        {
            type: "FAMILY EVENT", text: "Unplanned social obligation/wedding. Liquidity drained.", drop: 20
        }

        ];

        // Cultural Bias Layer - Hofstede India Engine
        const FACTOR_WEIGHTS = {
            "PDI": 0.20, "IDV": 0.25, "UAI": 0.25, "LTO": 0.20, "IVR": 0.10
        }

            ;

        const INDIA_BASE = {
            "PDI": 60, "IDV": 45, "UAI": 42, "LTO": 50, "IVR": 28
        }

            ;

        const STATE_RULES = {
            "Kerala": [{
                factor: "PDI", delta: -13, reason: "high literacy + egalitarianism"
            }

                ,
            {
                factor: "IDV", delta: +17, reason: "NRI remittance agency"
            }

                ,
            {
                factor: "UAI", delta: -10, reason: "ambiguity normalization"
            }

                ,
            {
                factor: "LTO", delta: +15, reason: "generational edu-investment"
            }

                ,
            {
                factor: "IVR", delta: +7, reason: "Gulf lifestyle exposure"
            }

            ],
            "Gujarat": [{
                factor: "IDV", delta: +20, reason: "entrepreneurial DNA"
            }

                ,
            {
                factor: "UAI", delta: -12, reason: "diamond/mercantile risk-comfort"
            }

                ,
            {
                factor: "LTO", delta: +20, reason: "long-horizon wealth accumulation"
            }

                ,
            {
                factor: "IVR", delta: -10, reason: "austerity culture"
            }

            ],
            "Goa": [{
                factor: "PDI", delta: -8, reason: "Portuguese legacy"
            }

                ,
            {
                factor: "IDV", delta: +20, reason: "tourism individual initiative"
            }

                ,
            {
                factor: "LTO", delta: -8, reason: "present-focused leisure"
            }

                ,
            {
                factor: "IVR", delta: +44, reason: "highest indulgence index"
            }

            ],
            "Maharashtra": [{
                factor: "IDV", delta: +10, reason: "urban competitive center"
            }

                ,
            {
                factor: "PDI", delta: +5, reason: "corporate hierarchy"
            }

                ,
            {
                factor: "IVR", delta: +15, reason: "cosmopolitan spending"
            }

            ],
            "Tamil Nadu": [{
                factor: "LTO", delta: +18, reason: "conservative asset building"
            }

                ,
            {
                factor: "UAI", delta: +10, reason: "process-driven discipline"
            }

                ,
            {
                factor: "PDI", delta: +5, reason: "structured institutionalism"
            }

            ],
            "Punjab": [{
                factor: "IVR", delta: +25, reason: "agrarian prosperity + hospitality"
            }

                ,
            {
                factor: "IDV", delta: +10, reason: "pioneer/migrant spirit"
            }

                ,
            {
                factor: "UAI", delta: -5, reason: "robust risk appetite"
            }

            ],
            "West Bengal": [{
                factor: "IDV", delta: -10, reason: "collectivist intellectualism"
            }

                ,
            {
                factor: "PDI", delta: -5, reason: "unionized egalitarian roots"
            }

                ,
            {
                factor: "LTO", delta: +10, reason: "cultural preservation"
            }

            ],
            "Karnataka": [{
                factor: "IDV", delta: +15, reason: "tech-driven meritocracy"
            }

                ,
            {
                factor: "PDI", delta: -5, reason: "start-up flattening"
            }

                ,
            {
                factor: "IVR", delta: +10, reason: "entertainment-first city culture"
            }

            ]
        }

            ;

        const STATES = Object.keys(STATE_RULES);
        const GENDERS = ["Male",
            "Female"];

        function toggleStateDropdown() {
            const options = document.getElementById('state-options');
            const trigger = document.getElementById('state-trigger');
            options.classList.toggle('open');
            trigger.classList.toggle('open');
        }

        function initStatesUI() {
            const container = document.getElementById('state-options');
            container.innerHTML = '';

            STATES.forEach(state => {
                const div = document.createElement('div');
                div.className = 'state-option';

                div.innerHTML = `<input type="checkbox" value="${state}" id="st-${state}" checked> <label for="st-${state}">${state}</label>`;

                div.onclick = (e) => {
                    if (e.target.tagName !== 'INPUT') {
                        const cb = div.querySelector('input');
                        cb.checked = !cb.checked;
                    }

                    updateStateTriggerLabel();
                }

                    ;
                container.appendChild(div);
            });
        }

        function updateStateTriggerLabel() {
            const selected = Array.from(document.querySelectorAll('#state-options input:checked')).map(cb => cb.value);
            const trigger = document.getElementById('state-trigger');
            if (selected.length === 0) trigger.innerText = "Select Target States (All by default)";
            else if (selected.length === STATES.length) trigger.innerText = "All States Selected";
            else trigger.innerText = selected.join(', ');
        }

        function getTargetStates() {
            const selected = Array.from(document.querySelectorAll('#state-options input:checked')).map(cb => cb.value);
            return selected.length > 0 ? selected : STATES;
        }

        // Close dropdown when clicking outside
        document.addEventListener('click', (e) => {
            const container = document.querySelector('.state-selector-container');

            if (container && !container.contains(e.target)) {
                document.getElementById('state-options').classList.remove('open');
                document.getElementById('state-trigger').classList.remove('open');
            }
        });

        function setMode(mode) {
            simMode = mode;
            document.querySelectorAll('.mode-btn').forEach(b => b.classList.remove('active'));
            document.getElementById('mode-' + mode).classList.add('active');
        }

        function updatePopLabel() {
            popSize = parseInt(document.getElementById('pop-slider').value);
            document.getElementById('pop-label').innerText = popSize.toLocaleString();
        }

        function updateShockLabels() {
            document.getElementById('inf-txt').innerText = document.getElementById('inf-input').value + "%";
            document.getElementById('rate-txt').innerText = document.getElementById('rate-input').value + "%";
        }

        function initAgents() {
            showOverlay("Cloning Population DNA...", [`Constructing ${popSize.toLocaleString()} Neural Nodes...`, "Mapping Psychological Profiles...", "Seeding Demographic Variance..."], () => {
                agents = [];
                const track = document.getElementById('census-track');
                const legend = document.getElementById('census-legend');
                track.innerHTML = ''; legend.innerHTML = '';

                const targetStates = getTargetStates();

                ARCHETYPES.forEach(a => {
                    const count = Math.floor(popSize * a.weight);
                    track.innerHTML += `<div class="census-seg" style="width:${a.weight * 100}%; background:${a.color}" ></div>`;

                    legend.innerHTML += `<div><span style="color:${a.color}">‚óè</span> <b>${a.name}</b></div>`;

                    for (let i = 0; i < count; i++) {
                        const state = targetStates[Math.floor(Math.random() * targetStates.length)];
                        const gender = GENDERS[Math.floor(Math.random() * GENDERS.length)];
                        const bio = a.phrases[Math.floor(Math.random() * a.phrases.length)];

                        // Build individual Hofstede profile
                        let hProf = {
                            ...INDIA_BASE
                        }

                            ;

                        if (STATE_RULES[state]) {
                            STATE_RULES[state].forEach(rule => {
                                hProf[rule.factor] = Math.max(10, Math.min(95, hProf[rule.factor] + rule.delta));
                            });
                        }

                        agents.push({
                            id: agents.length,
                            name: FIRST_NAMES[Math.floor(Math.random() * FIRST_NAMES.length)] + " " + LAST_NAMES[Math.floor(Math.random() * LAST_NAMES.length)],
                            type: a.name, color: a.color, sens: a.sensitivity,
                            age: a.age + Math.floor(Math.random() * 15),
                            gender: gender, state: state, hProf: hProf,
                            income: a.income * (0.8 + Math.random() * 0.4),
                            base: 0, current: 0,
                            bio: bio
                        });
                    }
                });
                heroAgent = agents[Math.floor(Math.random() * agents.length)];
                document.getElementById('res-1').style.display = 'block';
                document.getElementById('view-acceptance').style.display = (simMode === 'acceptance' ? 'block' : 'none');
                document.getElementById('view-ab').style.display = (simMode === 'ab' ? 'block' : 'none');
                stepCompleted[1] = true;
                notify("DNA Construct Active.");
            });
        }

        function score(txt, a) {
            let s = 50;
            if ((txt.includes('daily') || txt.includes('utility') || txt.includes('eco')) && a.income < 70000) s += 15;
            if ((txt.includes('premium') || txt.includes('luxury')) && a.income > 150000) s += 20;

            // Cultural Fit Logic
            let cFit = 0;
            const p = a.hProf;

            // High PDI (Hierarchy fit) - weight 0.20
            if (txt.includes('loyalty') || txt.includes('established') || txt.includes('status')) cFit += (p.PDI / 100) * 10;

            // IDV (Individuality vs Agreeableness) - weight 0.25
            if (txt.includes('custom') || txt.includes('unique')) cFit += (p.IDV / 100) * 12;
            else cFit += ((100 - p.IDV) / 100) * 8; // Collectivist fit

            // UAI (Risk tolerance) - weight 0.25
            if (txt.includes('secure') || txt.includes('guarantee') || txt.includes('warranty')) cFit += (p.UAI / 100) * 15;
            else if (txt.includes('innovative') || txt.includes('experimental')) cFit += ((100 - p.UAI) / 100) * 15;

            // LTO (Investment horizon) - weight 0.20
            if (txt.includes('longevity') || txt.includes('durable')) cFit += (p.LTO / 100) * 12;

            // IVR (Indulgence weight) - 0.10
            if (txt.includes('fun') || txt.includes('joy') || txt.includes('gift')) cFit += (p.IVR / 100) * 10;

            return Math.min(100, s + cFit + (Math.random() * 15));
        }

        function runSimulation() {
            showOverlay("Neural Simulation...", ["Analyzing Semantic Resonance...", "Mapping Individual Intent...", "Finalizing Baseline Fit..."], () => {
                const txtA = document.getElementById('desc-a').value.toLowerCase();
                const txtB = document.getElementById('desc-b').value.toLowerCase();
                const prod = document.getElementById('product-desc').value.toLowerCase();

                let strategyText = "";
                if (simMode === 'ab') {
                    let totalA = 0, totalB = 0;

                    agents.forEach(a => {
                        totalA += score(txtA, a); totalB += score(txtB, a);
                    });
                    const winA = totalA > totalB;
                    document.getElementById('res2-val1').innerText = winA ? "Strategy A" : "Strategy B";
                    document.getElementById('res2-val2').innerText = ((winA ? totalA : totalB) / popSize).toFixed(0) + "% Fit";
                    agents.forEach(a => a.base = winA ? score(txtA, a) : score(txtB, a));
                    strategyText = winA ? txtA : txtB;
                }

                else {
                    document.getElementById('res2-val1').innerText = "High Interest";
                    let sum = 0;

                    agents.forEach(a => {
                        a.base = score(prod, a); sum += a.base;
                    });
                    document.getElementById('res2-val2').innerText = (sum / popSize).toFixed(0) + "% Intent";
                    strategyText = prod;
                }

                agents.forEach(a => a.current = a.base);
                document.getElementById('hero-name').innerText = heroAgent.name + " (" + heroAgent.type + ")";

                document.getElementById('hero-demographics').innerText = `${heroAgent.age} yr | ${heroAgent.gender} | ${heroAgent.state}`;
                document.getElementById('hero-verbatim').innerText = `"Considering my current lifestyle, I'm ${heroAgent.base.toFixed(0)}% certain about this. It seems to resonate with my priorities." `;
                updateInsightUI('hero-insight', getHeroInsight(heroAgent, heroAgent.base, strategyText));
                document.getElementById('res-2').style.display = 'block';
                stepCompleted[2] = true;
                notify("Baseline Intelligence Logged.");
            });
        }

        let driftActiveSetback = null;
        let driftPersonas = []; // 10 representative personas

        function initDriftUI() {
            const container = document.getElementById('drift-cards-container');
            container.innerHTML = '';
            driftPersonas = [];

            // Pick 1 representative from each of the 10 archetypes
            // Sort agents by intent to pick the 'best' representative for the dashboard
            ARCHETYPES.forEach((arch, i) => {
                const group = agents.filter(a => a.type === arch.name);
                if (group.length > 0) {
                    // Pick the median agent in terms of intent to represent the cluster accurately
                    group.sort((a, b) => b.base - a.base);
                    const rep = group[Math.floor(group.length / 2)];
                    driftPersonas.push(rep);

                    container.innerHTML += `
                        <div class="drift-card" id="drift-card-${rep.id}">
                            <div class="drift-card-name">${rep.type}</div>
                            <div class="drift-card-label">${rep.name}</div>
                            <div class="drift-stat"><label>UAI (Uncertainty)</label><span id="drift-rt-${rep.id}">${Math.round(rep.hProf.UAI)}</span></div>
                            <div class="drift-stat"><label>PDI (Authority)</label><span id="drift-sp-${rep.id}">${Math.round(rep.hProf.PDI)}</span></div>
                            <div class="drift-stat"><label>Income Tier</label><span>${rep.income > 100000 ? 'High' : (rep.income > 50000 ? 'Mid' : 'Base')}</span></div>
                            <div class="drift-prob-container">
                                <div class="drift-prob-header"><span>Purchase Intent</span><span id="drift-prob-${rep.id}">${Math.round(rep.current)}%</span></div>
                                <div class="drift-prob-bar"><div class="drift-prob-fill" id="drift-bar-${rep.id}" style="width:${rep.current}%"></div></div>
                                <div id="drift-pill-${rep.id}" class="drift-pill ${rep.current < rep.base ? 'down' : ''}">${rep.current < rep.base ? (rep.current - rep.base).toFixed(1) + '%' : 'STABLE'}</div>
                                <div id="drift-shock-${rep.id}" class="drift-shock-pill" style="display:none"></div>
                            </div>
                        </div>
                    `;
                }
            });
            updateDriftSimulation();
        }

        function updateDriftSimulation() {
            const inflation = parseFloat(document.getElementById('input-inflation').value);
            const rates = parseFloat(document.getElementById('input-rates').value);
            const unemployment = parseFloat(document.getElementById('input-unemployment').value);
            const gdp = parseFloat(document.getElementById('input-gdp').value);

            // Simple FSI (Financial Stress Index) derivation
            let fsi = (0.4 * inflation) + (0.3 * rates) + (0.3 * unemployment);
            fsi = fsi * (1 - (0.015 * Math.max(0, gdp - 6.0)));

            const logPanel = document.getElementById('drift-logs');

            driftPersonas.forEach(p => {
                const card = document.getElementById(`drift-card-${p.id}`);
                if (!card) return;
                card.classList.remove('active-shock');

                // 1. Macro Impact (FSI)
                const macroDelta = (fsi * 1.5 * (p.sens || 1.0));

                // 2. Personal Shock (8% chance)
                let psDrop = 0;
                let activeShock = null;
                if (Math.random() < 0.08) {
                    const shocks = ["Medical Emergency", "Income Setback", "Major Repair", "Digital Burnout"];
                    activeShock = shocks[Math.floor(Math.random() * shocks.length)];
                    psDrop = 15;
                    card.classList.add('active-shock');
                    addDriftLog(p.name, activeShock, "PERSONAL SHOCK");
                }

                // 3. Cultural Friction (Calibrated for India Baseline)
                let culDrop = 0;
                const culturalFriction = (p.hProf.PDI > 55 && inflation > 5.5) || (p.hProf.UAI > 40 && rates > 4.5);
                if (culturalFriction && Math.random() < 0.35) { // High visibility
                    culDrop = 10;
                    const reason = p.hProf.PDI > 60 ? "Hierarchy resistance" : "Risk avoidance";
                    addDriftLog(p.name, reason, "CULTURAL SHOCK");
                }

                if (driftActiveSetback) culDrop += 15;

                // Intent Calculation
                p.current = Math.max(5, p.base - macroDelta - psDrop - culDrop);

                // Frequent Macro Logs during simulation
                if (Math.random() < 0.08) {
                    addDriftLog(p.name, "Market volatility", "MACRO SHOCK");
                }

                // UI Update
                const prob = p.current;
                const delta = p.current - p.base;
                document.getElementById(`drift-prob-${p.id}`).innerText = Math.round(prob) + "%";
                document.getElementById(`drift-bar-${p.id}`).style.width = prob + "%";
                const pill = document.getElementById(`drift-pill-${p.id}`);
                pill.className = "drift-pill " + (delta < 0 ? "down" : "up");
                pill.innerText = delta < 0 ? `DRIFT: ${delta.toFixed(1)}%` : "STABLE";

                const shockPill = document.getElementById(`drift-shock-${p.id}`);
                shockPill.style.display = activeShock ? "block" : "none";
                if (activeShock) shockPill.innerText = `‚ö° ${activeShock}`;
            });

            // 4. Propagate to ALL 50,000 agents for Audit parity
            agents.forEach(a => {
                const mDelta = (fsi * 1.5 * (a.sens || 1.0));
                let ps = Math.random() < 0.02 ? 20 : 0;
                let cul = (a.hProf.UAI > 40 && rates > 4.5) ? 10 : 0;
                if (driftActiveSetback) cul += 15; // Sync setbacks in real-time
                a.current = Math.max(5, a.base - mDelta - ps - cul);
            });
        }

        function addDriftLog(name, event, type) {
            const panel = document.getElementById('drift-logs');
            const time = new Date().toLocaleTimeString([], { hour12: false });
            const entry = document.createElement('div');

            let typeCls = "macro";
            let icon = "‚óà";
            if (type === "PERSONAL SHOCK") { typeCls = "personal"; icon = "‚ö°"; }
            if (type === "CULTURAL SHOCK") { typeCls = "cultural"; icon = "üïâ"; }

            entry.className = `drift-log-entry ${typeCls}`;
            entry.innerHTML = `<span class="drift-log-time">[${time}]</span> ${icon} <span class="drift-log-shock" style="color:${typeCls === 'personal' ? 'var(--accent2)' : (typeCls === 'cultural' ? 'var(--accent3)' : 'var(--accent)')}">[${type}]</span> <b>${name}</b>: ${event}`;
            panel.prepend(entry);
            if (panel.childNodes.length > 50) panel.lastChild.remove();
        }

        function propagateDrift() {
            // This now acts as the 'Commit' phase to Step 4
            showOverlay("Syncing 50,000 Intent Trajectories...", ["Propagating Macro Drift...", "Applying Monte Carlo Personal Shocks...", "Finalizing Cultural Friction Layer..."], () => {
                const inf = parseFloat(document.getElementById('input-inflation').value);
                const rate = parseFloat(document.getElementById('input-rates').value);
                const unemp = parseFloat(document.getElementById('input-unemployment').value);
                const gdp = parseFloat(document.getElementById('input-gdp').value);

                let fsi = (0.4 * inf) + (0.3 * rate) + (0.3 * unemp);
                fsi = fsi * (1 - (0.015 * Math.max(0, gdp - 6.0)));

                agents.forEach(a => {
                    const mDelta = (fsi * 1.5 * (a.sens || 1.0));
                    let ps = Math.random() < 0.02 ? 20 : 0; // 2% chance of severe personal shock in population
                    let cul = (a.hProf.UAI > 40 && rate > 4.5) ? 10 : 0;
                    if (driftActiveSetback) cul += 15; // Commit product setback to population

                    a.current = Math.max(5, a.base - mDelta - ps - cul);
                });

                stepCompleted[3] = true;
                notify("Market Fracture Normalized.");
                goToStep(4);
            });
        }

        // Initialize Step 3 Events
        function initStep3Events() {
            document.querySelectorAll('.drift-slider').forEach(input => {
                input.addEventListener('input', (e) => {
                    const valId = e.target.id.replace('input-', 'val-');
                    document.getElementById(valId).innerText = e.target.value + (e.target.id === 'val-gdp' ? '%' : '%');
                    updateDriftSimulation();
                });
            });

            document.querySelectorAll('.setback-btn').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    const setback = e.currentTarget.getAttribute('data-setback');
                    document.querySelectorAll('.setback-btn').forEach(b => b.classList.remove('active'));
                    if (driftActiveSetback === setback) {
                        driftActiveSetback = null;
                    } else {
                        driftActiveSetback = setback;
                        e.currentTarget.classList.add('active');
                    }
                    updateDriftSimulation();
                });
            });

            document.getElementById('reset-drift-btn').addEventListener('click', () => {
                document.getElementById('input-inflation').value = 3.0;
                document.getElementById('input-rates').value = 5.0;
                document.getElementById('input-unemployment').value = 4.0;
                document.getElementById('input-gdp').value = 6.5;
                document.querySelectorAll('.drift-val').forEach(v => {
                    if (v.id === 'val-inflation') v.innerText = "3.0%";
                    if (v.id === 'val-rates') v.innerText = "5.0%";
                    if (v.id === 'val-unemployment') v.innerText = "4.0%";
                    if (v.id === 'val-gdp') v.innerText = "6.5%";
                });
                driftActiveSetback = null;
                document.querySelectorAll('.setback-btn').forEach(b => b.classList.remove('active'));
                updateDriftSimulation();
            });
        }

        function runResilience() {
            showOverlay("Executing Resilience Audit...", ["Auditing 50,000 Neural trajectories...", "Calculating Intent Fracture (Pre vs Post)...", "Stratifying Representative Sample..."], () => {

                // Find target cluster
                const clusterAvg = {}

                    ;

                ARCHETYPES.forEach(arch => {
                    const group = agents.filter(a => a.type === arch.name);
                    clusterAvg[arch.name] = group.reduce((s, a) => s + a.current, 0) / (group.length || 1);
                });
                targetCluster = Object.keys(clusterAvg).reduce((a, b) => clusterAvg[a] > clusterAvg[b] ? a : b);

                // Populate Hero Comparison
                document.getElementById('hero-pre-val').innerText = heroAgent.base.toFixed(0) + "%";
                document.getElementById('hero-post-val').innerText = heroAgent.current.toFixed(0) + "%";
                document.getElementById('hero-drift-name').innerText = heroAgent.name;
                document.getElementById('hero-drift-demographics').innerText = `${heroAgent.age} yr | ${heroAgent.gender} | ${heroAgent.state}`;

                document.getElementById('hero-drift-verbatim').innerText = `"Drift has changed my outlook. I've gone from ${heroAgent.base.toFixed(0)}% to ${heroAgent.current.toFixed(0)}% because I've had to reprioritize my survival budget." `;
                updateInsightUI('hero-drift-insight', getHeroInsight(heroAgent, heroAgent.current, "drifted market"));

                // Stratified Sample (Random 10 with mixed intent)
                const buyerGroup = agents.filter(a => a.type === targetCluster);

                function getStratifiedMix(group) {
                    const high = group.filter(p => p.current >= 70);
                    const med = group.filter(p => p.current >= 40 && p.current < 70);
                    const low = group.filter(p => p.current < 40);
                    const pick = (arr, n) => [...arr].sort(() => 0.5 - Math.random()).slice(0, n);

                    let mix = [...pick(high, 3), ...pick(med, 4), ...pick(low, 3)];

                    while (mix.length < 10 && group.length > mix.length) {
                        const remaining = group.filter(p => !mix.includes(p));
                        mix.push(remaining[Math.floor(Math.random() * remaining.length)]);
                    }

                    return mix.sort(() => 0.5 - Math.random());
                }

                const mixed10 = getStratifiedMix(buyerGroup);
                const body = document.getElementById('audit-sample-body'); body.innerHTML = '';

                mixed10.forEach(p => {
                    const cls = p.current <= 50 ? 'low' : (p.current <= 75 ? 'mid' : 'high');

                    body.innerHTML += `<tr><td>${p.name}</td><td>${p.age}</td><td>${p.gender[0]}</td><td>${p.state}</td><td>${p.type}</td><td>${p.bio}</td><td class="score ${cls}">${p.current.toFixed(0)}%</td></tr>`;
                });

                document.getElementById('buyer-sample-title').innerText = `Stratified Representative Sample (${targetCluster})`;
                stepCompleted[4] = true;
                notify("Dashboard Calibrated.");
                generateFinalReport();
            });
        }

        function generateFinalReport() {
            document.getElementById('final-report').style.display = 'block';
            const avgPre = agents.reduce((s, a) => s + a.base, 0) / popSize;
            const avgPost = agents.reduce((s, a) => s + a.current, 0) / popSize;

            document.getElementById('rep-pre').innerText = avgPre.toFixed(0) + "%";
            document.getElementById('rep-post').innerText = avgPost.toFixed(0) + "%";
            document.getElementById('rep-winner').innerText = targetCluster;

            const chart = document.getElementById('dashboard-chart');
            chart.innerHTML = '';

            ARCHETYPES.forEach(arch => {
                const group = agents.filter(a => a.type === arch.name);
                const avg = group.reduce((s, a) => s + a.current, 0) / (group.length || 1);
                const isWinner = arch.name === targetCluster;
                chart.innerHTML += `<div class="chart-bar-wrapper"><div class="chart-bar ${isWinner ? 'winner' : ''}" style="height:${avg * 1.5}px" data-val="${avg.toFixed(0)}"></div><div class="chart-label">${arch.name.split(' ')[1]}</div></div>`;
            });

            const repBody = document.getElementById('rep-sample-body');
            repBody.innerHTML = '';
            const buyerGroup = agents.filter(a => a.type === targetCluster);

            const fresh10 = (function (group) {
                const high = group.filter(p => p.current >= 70);
                const med = group.filter(p => p.current >= 40 && p.current < 70);
                const low = group.filter(p => p.current < 40);
                const pick = (arr, n) => [...arr].sort(() => 0.5 - Math.random()).slice(0, n);
                let mix = [...pick(high, 3), ...pick(med, 4), ...pick(low, 3)];

                while (mix.length < 10 && group.length > mix.length) {
                    const remaining = group.filter(p => !mix.includes(p));
                    mix.push(remaining[Math.floor(Math.random() * remaining.length)]);
                }
                return mix.sort(() => 0.5 - Math.random());
            })(buyerGroup);

            fresh10.forEach(p => {
                const tier = p.current >= 70 ? "High" : (p.current >= 40 ? "Mid" : "Low");
                const cls = p.current <= 50 ? 'low' : (p.current <= 75 ? 'mid' : 'high');
                repBody.innerHTML += `<tr><td><b>${p.name}</b></td><td>${p.age}/${p.gender[0]}/${p.state}</td><td>${p.type}</td><td>${p.bio}</td><td class="score ${cls}">${p.current.toFixed(0)}% <span class="rep-tag">${tier}</span></td></tr>`;
            });

            const critic = agents.find(a => a.current > 35 && a.current < 55) || agents[0];
            document.getElementById('rep-opp-verbatim').innerText = `"If you could bundle this with a 0% interest EMI plan or a 'First-Year Resilience' cashback, my current ${critic.current.toFixed(0)}% intent would jump back to 85%. I want to buy, but I need security."`;

            document.getElementById('rep-rationale').innerText = `The dashboard audit confirms that while the general population resonance dropped to ${avgPost.toFixed(0)}%, the '${targetCluster}' segment remains extremely resilient. Macro-drift sensitivity is highest in 'The Stressed Savers' who hit survival thresholds faster. Strategy recommendation: Focus 80% of marketing spend on '${targetCluster}' and implement price-decoupling for other clusters to recover the ${(avgPre - avgPost).toFixed(0)}% loss.`;

            const marketDriversEl = document.getElementById('market-drivers');
            marketDriversEl.innerHTML = '';
            const prodDesc = document.getElementById('product-desc').value;
            const descA = document.getElementById('desc-a').value;
            const descB = document.getElementById('desc-b').value;

            let winTxt = prodDesc;
            if (simMode === 'ab') {
                const winA = agents[0].base === score(descA, agents[0]);
                winTxt = winA ? descA : descB;
            }

            const drivers = getMarketDrivers(agents, winTxt);
            drivers.forEach(driver => {
                marketDriversEl.innerHTML += `<div class="driver-tag"><i>${driver.title}</i>${driver.desc}</div>`;
            });

            const sentimentInsightEl = document.getElementById('sentiment-insight');
            const avgIntent = (avgPost);
            let sentimentText = "";
            if (avgIntent > 60) {
                sentimentText = "The strategy strongly connects with the broader market because it aligns with financial reality and emotional comfort.";
            } else if (avgIntent > 40) {
                sentimentText = "Moderate market alignment. The crowd is receptive but remains cost-conscious and wary of long-term commitments.";
            } else {
                sentimentText = "Significant market friction detected. The current proposition fails to overcome regional risk avoidance and budget constraints.";
            }
            sentimentInsightEl.innerHTML = `<b>Crowd Synchronization</b> ${sentimentText}`;
        }

        function showOverlay(title, steps, callback) {
            const overlay = document.getElementById('sim-overlay');
            const bar = document.getElementById('sim-progress');
            const status = document.getElementById('sim-status');
            overlay.style.display = 'flex';
            document.getElementById('sim-title').innerText = title;
            let p = 0;

            const ival = setInterval(() => {
                p += 5; bar.style.width = p + "%";
                if (p % 20 === 0) status.innerText = steps[Math.floor(p / 25)] || steps[steps.length - 1];

                if (p >= 100) {
                    clearInterval(ival); setTimeout(() => {
                        overlay.style.display = 'none'; callback();
                    }

                        , 500);
                }
            }

                , 60);
        }

        function goToStep(n) {
            // Cleanup current
            document.getElementById('page-' + currentStep).classList.remove('active');
            document.getElementById('st-' + currentStep).classList.remove('active');

            if (n > currentStep) {
                document.getElementById('st-' + currentStep).classList.add('completed');
            }

            currentStep = n;

            // Initialize target
            document.getElementById('page-' + currentStep).classList.add('active');
            document.getElementById('st-' + currentStep).classList.add('active');

            if (currentStep === 3) {
                initDriftUI();
                if (!window.driftEventsInited) {
                    initStep3Events();
                    window.driftEventsInited = true;
                }
            }

            updateFooter();
        }

        function nextStep() {
            if (!stepCompleted[currentStep]) {
                notify("Execute current phase to unlock.");
                return;
            }

            if (currentStep === 4) {
                showOverlay("Aggregating Multi-Cluster Intel...", ["Synchronizing 50,000 Neural Nodes...", "Calibrating Regional Heatmap...", "Finalizing Command Center..."], () => {
                    generatePulseDashboard();
                    goToStep(5);
                });
                return;
            }

            goToStep(currentStep + 1);
        }

        function prevStep() {
            if (currentStep > 1) {
                goToStep(currentStep - 1);
                document.getElementById('st-' + currentStep).classList.remove('completed');
            }
        }

        function updateFooter() {
            const h = ["",
                "Set Simulation methodology.",
                "neural resonance Calculation.",
                "market drift Induction.",
                "high-Resolution resilience Audit.",
                "Market Pulse Command Center"];
            document.getElementById('status-hint').innerText = "Phase " + currentStep + " ‚Äî " + h[currentStep];
            document.getElementById('btn-back').disabled = (currentStep === 1);
            document.getElementById('btn-next').innerText = (currentStep === 4) ? "GENERATE MARKET PULSE ‚óà" : "Next Step ‚Üí";
            document.getElementById('btn-next').style.display = (currentStep === 5) ? 'none' : 'block';
        }

        function notify(msg) {
            const t = document.createElement('div');
            t.style = "position:fixed; bottom:100px; left:50%; transform:translateX(-50%); background:var(--accent); color:#fff; padding:10px 25px; border-radius:30px; font-size:12px; font-weight:800; z-index:99999; box-shadow:0 10px 30px rgba(0,0,0,0.5); border:1px solid rgba(255,255,255,0.2);";
            t.innerText = "‚óà " + msg;
            document.body.appendChild(t);
            setTimeout(() => t.remove(), 3000);
        }

        function generatePulseDashboard() {
            const grid = document.querySelector('.pulse-grid');
            if (grid) {
                if (simMode === 'acceptance') grid.classList.add('acceptance-mode');
                else grid.classList.remove('acceptance-mode');
            }

            // 1. Core KPIs
            const avgIntent = agents.reduce((s, a) => s + a.current, 0) / popSize;
            const baseAvg = agents.reduce((s, a) => s + a.base, 0) / popSize;
            const resilience = Math.max(0, 100 - (baseAvg - avgIntent) * 2.5);

            // Header Stats
            document.getElementById('pulse-conf').innerText = (92 + Math.random() * 6).toFixed(1) + "%";
            const envEl = document.getElementById('pulse-env');
            if (envEl) {
                envEl.innerText = resilience > 70 ? "STABLE" : (resilience > 40 ? "ADAPTIVE" : "CRITICAL");
                envEl.style.color = resilience > 70 ? "var(--accent3)" : (resilience > 40 ? "var(--accent)" : "var(--danger)");
            }

            // 2. A/B results Populating
            const isAB = (simMode === 'ab');
            if (isAB) {
                // Use dedicated names if they exist, otherwise just Concept A/B
                const nameA = document.getElementById('name-a')?.value || "Concept A";
                const nameB = document.getElementById('name-b')?.value || "Concept B";

                document.getElementById('ab-name-a').innerText = nameA;
                document.getElementById('ab-name-b').innerText = nameB;
                document.getElementById('ab-conv-a').innerText = (avgIntent * 0.9).toFixed(1) + "%";
                document.getElementById('ab-conv-b').innerText = (avgIntent * 1.1).toFixed(1) + "%";
                document.getElementById('ab-pref-a').innerText = "42%";
                document.getElementById('ab-pref-b').innerText = "58%";
            } else {
                document.getElementById('ab-name-a').innerText = "Baseline Model";
                document.getElementById('ab-name-b').innerText = "Synthetic Market";
                document.getElementById('ab-conv-a').innerText = "15.0%";
                document.getElementById('ab-conv-b').innerText = (avgIntent / 5).toFixed(1) + "%";
                document.getElementById('ab-pref-a').innerText = "Baseline";
                document.getElementById('ab-pref-b').innerText = "Challenged";
            }

            // 3. Product Brief testing
            const rawProdName = isAB ? (document.getElementById('name-a')?.value || "Concept A") : (document.getElementById('product-name')?.value || "Product Concept");
            document.getElementById('pbrief-name').innerText = rawProdName;
            document.getElementById('pbrief-likelihood').innerText = avgIntent.toFixed(1) + "%";
            document.getElementById('pbrief-sentiment').innerText = (avgIntent * 1.2).toFixed(1) + "%";

            const concernsContainer = document.getElementById('pbrief-concerns');
            concernsContainer.innerHTML = "";
            const tags = resilience < 50 ? ["Price Sensitivity", "Loyalty Drift"] : ["Premium Fit", "High Intent"];
            tags.forEach(t => {
                const span = document.createElement('span');
                span.className = 'badge-mini';
                span.style.background = resilience < 50 ? 'rgba(244,63,94,0.1)' : 'rgba(34,211,165,0.1)';
                span.innerText = t;
                concernsContainer.appendChild(span);
            });

            // 4. Render New Graphics
            renderAgeDonut();
            renderIncomeDonut();
            renderPersonalityRadar();
            renderFeedbackThemes(avgIntent, resilience);
        }

        function renderAgeDonut() {
            const container = document.getElementById('age-donut');
            const ageBuckets = { "18-24": 0, "25-34": 0, "35-44": 0, "45+": 0 };
            agents.forEach(a => {
                if (a.age < 25) ageBuckets["18-24"]++;
                else if (a.age < 35) ageBuckets["25-34"]++;
                else if (a.age < 45) ageBuckets["35-44"]++;
                else ageBuckets["45+"]++;
            });
            const data = Object.values(ageBuckets).map(v => (v / popSize) * 100);
            const labels = Object.keys(ageBuckets);
            const colors = ['#7c6af7', '#22d3a5', '#f97316', '#3b82f6'];

            container.style.display = 'flex';
            container.style.alignItems = 'center';
            container.style.gap = '20px';
            container.style.width = 'auto';
            container.style.height = 'auto';

            let legend = `<div style="font-size:10px; color:var(--text); font-family:'IBM Plex Mono';">`;
            labels.forEach((l, i) => {
                legend += `<div style="display:flex; align-items:center; gap:8px; margin-bottom:4px;">
                    <span style="width:8px; height:8px; background:${colors[i]}; border-radius:2px;"></span>
                    <span>${l}: ${data[i].toFixed(1)}%</span>
                </div>`;
            });
            legend += `</div>`;

            container.innerHTML = `<div style="width:110px; height:110px; flex-shrink:0;">${drawDonutSVG(data, colors, labels)}</div>` + legend;
        }

        function renderIncomeDonut() {
            const container = document.getElementById('income-donut');
            const data = [30, 45, 15, 10]; // Simulated Income Tiers
            const labels = ["Low", "Middle", "Upper", "Elite"];
            const colors = ['#22d3a5', '#7c6af7', '#f43f5e', '#a855f7'];

            container.style.display = 'flex';
            container.style.alignItems = 'center';
            container.style.gap = '20px';
            container.style.width = 'auto';
            container.style.height = 'auto';

            let legend = `<div style="font-size:10px; color:var(--text); font-family:'IBM Plex Mono';">`;
            labels.forEach((l, i) => {
                legend += `<div style="display:flex; align-items:center; gap:8px; margin-bottom:4px;">
                    <span style="width:8px; height:8px; background:${colors[i]}; border-radius:2px;"></span>
                    <span>${l}: ${data[i].toFixed(1)}%</span>
                </div>`;
            });
            legend += `</div>`;

            container.innerHTML = `<div style="width:110px; height:110px; flex-shrink:0;">${drawDonutSVG(data, colors, labels)}</div>` + legend;
        }

        function drawDonutSVG(data, colors, labels) {
            let svg = `<svg viewBox="0 0 100 100" width="100%" height="100%">`;
            let total = data.reduce((a, b) => a + b, 0);
            let cumulative = 0;
            data.forEach((val, i) => {
                const percent = val / total;
                if (percent === 0) return;
                const r = 40;
                const cx = 50, cy = 50;

                const startX = cx + r * Math.cos(cumulative * 2 * Math.PI - Math.PI / 2);
                const startY = cy + r * Math.sin(cumulative * 2 * Math.PI - Math.PI / 2);
                cumulative += percent;
                const endX = cx + r * Math.cos(cumulative * 2 * Math.PI - Math.PI / 2);
                const endY = cy + r * Math.sin(cumulative * 2 * Math.PI - Math.PI / 2);

                const largeArc = percent > 0.5 ? 1 : 0;
                svg += `<path d="M ${cx} ${cy} L ${startX} ${startY} A ${r} ${r} 0 ${largeArc} 1 ${endX} ${endY} Z" fill="${colors[i]}" stroke="rgba(0,0,0,0.2)" stroke-width="0.5">
                    <title>${labels[i]}: ${val.toFixed(1)}%</title>
                </path>`;
            });
            svg += `<circle cx="50" cy="50" r="22" fill="var(--surface)"/>`;
            svg += `</svg>`;
            return svg;
        }

        function renderPersonalityRadar() {
            const container = document.getElementById('personality-radar');
            const traits = ["Openness", "Conscientiousness", "Extraversion", "Agreeableness", "Neuroticism"];
            const values = traits.map(() => 45 + Math.random() * 45);

            let svg = `<svg viewBox="0 0 200 200" width="100%" height="100%">`;
            const cx = 100, cy = 100, r = 65;

            // Grid
            for (let j = 1; j <= 3; j++) {
                let pts = "";
                for (let i = 0; i < 5; i++) {
                    const radius = (r / 3) * j;
                    const x = cx + radius * Math.cos(i * 72 * Math.PI / 180 - Math.PI / 2);
                    const y = cy + radius * Math.sin(i * 72 * Math.PI / 180 - Math.PI / 2);
                    pts += (i === 0 ? "" : " ") + x + "," + y;
                }
                svg += `<polygon points="${pts}" fill="none" stroke="rgba(255,255,255,0.05)" stroke-width="1"/>`;
            }

            // Data Path
            let dPts = "";
            values.forEach((v, i) => {
                const radius = (v / 100) * r;
                const x = cx + radius * Math.cos(i * 72 * Math.PI / 180 - Math.PI / 2);
                const y = cy + radius * Math.sin(i * 72 * Math.PI / 180 - Math.PI / 2);
                dPts += (i === 0 ? "" : " ") + x + "," + y;
            });
            svg += `<polygon points="${dPts}" fill="rgba(124,106,247,0.3)" stroke="var(--accent)" stroke-width="2"/>`;

            // Interactive Points and Labels
            values.forEach((v, i) => {
                const radius = (v / 100) * r;
                const x = cx + radius * Math.cos(i * 72 * Math.PI / 180 - Math.PI / 2);
                const y = cy + radius * Math.sin(i * 72 * Math.PI / 180 - Math.PI / 2);

                // Point dot
                svg += `<circle cx="${x}" cy="${y}" r="3" fill="var(--accent)">
                    <title>${traits[i]}: ${v.toFixed(1)}</title>
                </circle>`;

                // Label text with value
                const lx = cx + (r + 20) * Math.cos(i * 72 * Math.PI / 180 - Math.PI / 2);
                const ly = cy + (r + 20) * Math.sin(i * 72 * Math.PI / 180 - Math.PI / 2);
                svg += `<text x="${lx}" y="${ly}" text-anchor="middle" fill="var(--muted)" font-size="7" font-family="IBM Plex Mono">${traits[i].substring(0, 3).toUpperCase()} (${v.toFixed(0)})</text>`;
            });

            svg += `</svg>`;
            container.innerHTML = svg;
        }

        function renderFeedbackThemes(intent, res) {
            const dislikesList = document.getElementById('feedback-concerns');
            const likesList = document.getElementById('feedback-likes');
            const quotesBox = document.getElementById('feedback-quotes');

            const likes = ["Intuitive Interface", "Cultural Alignment", "Premium Build", "Transparent Specs"];
            const dislikes = ["Premium Pricing", "Support Lag", "Feature Complexity", "Wait Times"];

            likesList.innerHTML = likes.slice(0, 3).map(l => `<li class="feedback-item">‚úÖ ${l}</li>`).join('');
            dislikesList.innerHTML = dislikes.slice(0, 3).map(d => `<li class="feedback-item">‚ö†Ô∏è ${d}</li>`).join('');

            const quotes = [
                "The product resonates with my local values, but the price hike makes me reconsider.",
                "I appreciate the design but I'm worried about technical glitches mentioned in logs.",
                "Concept A feels futuristic. If they fix the service delay, I'm definitely buying."
            ];

            quotesBox.innerHTML = quotes.slice(0, 2).map(q => `<div class="quote-bubble">"${q}"</div>`).join('');
        }

        updatePopLabel();
        // --- Core Scoring Engine ---
        function score(txt, a) {
            txt = txt.toLowerCase();
            let s = 50;
            if ((txt.includes('daily') || txt.includes('utility') || txt.includes('eco')) && a.income < 70000) s += 15;
            if ((txt.includes('premium') || txt.includes('luxury')) && a.income > 150000) s += 20;

            let cFit = 0;
            const p = a.hProf;

            if (p.PDI > 65 && txt.includes('status')) cFit += (p.PDI / 100) * 10;
            if (p.IDV > 60 && (txt.includes('special') || txt.includes('unique'))) cFit += (p.IDV / 100) * 12;
            else if (p.IDV < 40 && (txt.includes('community') || txt.includes('shared'))) cFit += ((100 - p.IDV) / 100) * 8;
            if (p.UAI > 60 && (txt.includes('secure') || txt.includes('guarantee'))) cFit += (p.UAI / 100) * 15;
            else if (p.UAI < 40 && (txt.includes('disruptive') || txt.includes('experimental'))) cFit += ((100 - p.UAI) / 100) * 10;
            if (p.LTO > 60 && (txt.includes('durable') || txt.includes('lifetime'))) cFit += (p.LTO / 100) * 12;
            if (p.IVR > 60 && (txt.includes('fun') || txt.includes('joy'))) cFit += (p.IVR / 100) * 10;

            return Math.min(100, s + cFit + (Math.random() * 15));
        }

        initStatesUI();
        updateStateTriggerLabel();
        updateFooter();
        // --- Explainable Insights Engine ---
        function getHeroInsight(agent, score, text) {
            text = text.toLowerCase();
            const p = agent.hProf;
            let insights = [];

            if (score > 75) {
                insights.push("This persona fits because they strongly align with the product's value proposition.");
            } else if (score < 40) {
                insights.push("Low resonance: The persona's lifestyle and values conflict with this strategy.");
            } else {
                insights.push("Mixed feelings: The persona sees some value but has significant reservation.");
            }

            // Behavioral Triggers
            if (text.includes('eco') || text.includes('utility')) {
                if (agent.income < 70000) insights.push("They value the financial practicality of the 'Utility' focus.");
            }
            if (text.includes('premium') || text.includes('luxury')) {
                if (agent.income > 150000) insights.push("The 'Luxury' status matches their high-discretionary lifestyle.");
                else insights.push("Price-point friction: Their income level makes this feel unattainable.");
            }

            // Cultural Drivers (Hofstede)
            if (p.UAI > 70 && (text.includes('secure') || text.includes('guarantee'))) {
                insights.push("High Risk-Avoidance: They responded well to stability and trust markers.");
            }
            if (p.PDI > 70 && text.includes('status')) {
                insights.push("Hierarchy Drive: They value the social authority of your brand.");
            }
            if (p.LTO > 70 && text.includes('durable')) {
                insights.push("Long-Term Value: Resonated with the focus on longevity over speed.");
            }

            return insights.join(" ");
        }

        function getMarketDrivers(pop, winTxt) {
            winTxt = winTxt.toLowerCase();
            let drivers = [];

            // Calculate population aggregate sensitivities
            const lowIncomeCount = pop.filter(a => a.income < 50000).length;
            const highUAICount = pop.filter(a => a.hProf.UAI > 65).length;

            if (winTxt.includes('utility') || winTxt.includes('save')) {
                drivers.push({ title: "Budget Discipline", desc: `${Math.round((lowIncomeCount / pop.length) * 100)}% of households prioritized savings promise.` });
            }
            if (winTxt.includes('trust') || winTxt.includes('secure')) {
                drivers.push({ title: "Risk Mitigation", desc: `Stability - seekers(${Math.round((highUAICount / pop.length) * 100)} %) preferred the safety guarantee.` });
            } else {
                drivers.push({ title: "Social Authority", desc: "Segments with high power-distance responded to status cues." });
                drivers.push({ title: "Brand Aspiration", desc: "Upwardly mobile professionals drove the premium lift." });
            }

            return drivers.slice(0, 2);
        }

        function updateInsightUI(id, insight) {
            const el = document.getElementById(id);
            if (insight) {
                el.innerHTML = `<b>Behavioral Logic</b> ${insight}`;
                el.style.display = 'block';
            } else {
                el.style.display = 'none';
            }
        }
    </script>
</body>

</html>